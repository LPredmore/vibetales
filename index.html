
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>StoryBridge - Story Generator</title>
    <meta name="description" content="Create magical stories for young readers with sight words practice" />
    <meta name="author" content="StoryBridge" />
    <meta name="keywords" content="story generator, sight words, reading, children, education" />
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#8B5CF6" />
    <meta name="background-color" content="#F3E8FF" />
    <meta name="display" content="standalone" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- iOS Specific -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="StoryBridge" />
    
    <!-- Microsoft specific -->
    <meta name="msapplication-TileColor" content="#8B5CF6" />
    <meta name="msapplication-config" content="none" />
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512x512.png" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="mask-icon" href="/pwa-512x512.png" color="#8B5CF6" />
    
    <!-- Social Media -->
    <meta property="og:title" content="StoryBridge - Story Generator" />
    <meta property="og:description" content="Create magical stories for young readers with sight words practice" />
    <meta property="og:image" content="/pwa-512x512.png" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="StoryBridge - Story Generator" />
    <meta name="twitter:description" content="Create magical stories for young readers with sight words practice" />
    <meta name="twitter:image" content="/pwa-512x512.png" />
  </head>

  <body>
    <div id="root"></div>
    
    <!-- Emergency Fallback Screen for critical failures -->
    <div id="emergency-fallback" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #F3E8FF; z-index: 9999; padding: 20px; font-family: Arial, sans-serif; text-align: center; overflow-y: auto;">
      <div style="max-width: 500px; margin: 20px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <h1 style="color: #8B5CF6; margin-bottom: 20px;">ğŸ”§ StoryBridge Recovery Mode</h1>
        <div id="fallback-info">
          <p style="margin-bottom: 15px; color: #666;">Attempting to recover from loading issues...</p>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; text-align: left; margin: 15px 0; border: 1px solid #e9ecef;">
            <div style="margin: 5px 0;">ğŸŒ <strong>URL:</strong> <span id="current-url"></span></div>
            <div style="margin: 5px 0;">ğŸ“± <strong>Device:</strong> <span id="user-agent"></span></div>
            <div style="margin: 5px 0;">ğŸ”„ <strong>Service Worker:</strong> <span id="sw-status">Checking...</span></div>
            <div style="margin: 5px 0;">â° <strong>Load Time:</strong> <span id="load-time"></span></div>
            <div style="margin: 5px 0;">ğŸ¯ <strong>React App:</strong> <span id="react-status">Loading...</span></div>
            <div style="margin: 5px 0;">ğŸŒ <strong>Network:</strong> <span id="network-status">Testing...</span></div>
            <div style="margin: 5px 0;">ğŸ“± <strong>PWA Mode:</strong> <span id="pwa-mode">Detecting...</span></div>
          </div>
          <div style="margin: 20px 0;">
            <button onclick="performNuclearReset()" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px;">ğŸ—‘ï¸ Nuclear Reset</button>
            <button onclick="bypassServiceWorker()" style="background: #059669; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px;">ğŸš« Bypass SW</button>
            <button onclick="diagnosticReload()" style="background: #8B5CF6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px;">ğŸ”„ Diagnostic Reload</button>
          </div>
          <div id="error-log" style="background: #fef2f2; border: 1px solid #fecaca; padding: 15px; border-radius: 5px; font-size: 12px; text-align: left; margin: 15px 0; display: none;">
            <h4 style="color: #dc2626; margin: 0 0 10px 0;">ğŸš¨ Error Log:</h4>
            <div id="error-content"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const startTime = Date.now();
      let emergencyShown = false;
      let reactLoaded = false;
      let errorLog = [];
      
      // Populate emergency diagnostic info immediately
      document.getElementById('current-url').textContent = window.location.href;
      document.getElementById('user-agent').textContent = navigator.userAgent.substring(0, 60) + '...';
      document.getElementById('load-time').textContent = new Date().toLocaleTimeString();
      
      // Detect PWA mode
      const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone === true ||
                    document.referrer.includes('android-app://');
      document.getElementById('pwa-mode').textContent = isPWA ? 'PWA Mode âœ…' : 'Browser Mode ğŸŒ';
      
      // Log errors
      function logError(error) {
        errorLog.push(`${new Date().toLocaleTimeString()}: ${error}`);
        updateErrorDisplay();
      }
      
      function updateErrorDisplay() {
        const errorEl = document.getElementById('error-log');
        const contentEl = document.getElementById('error-content');
        if (errorLog.length > 0) {
          errorEl.style.display = 'block';
          contentEl.innerHTML = errorLog.map(err => `<div style="margin: 2px 0; padding: 5px; background: white; border-radius: 3px; font-size: 11px;">${err}</div>`).join('');
        }
      }
      
      // Nuclear reset function
      async function performNuclearReset() {
        logError('ğŸ—‘ï¸ Performing nuclear reset...');
        
        try {
          // 1. Unregister ALL service workers
          if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const registration of registrations) {
              await registration.unregister();
              logError(`Unregistered SW: ${registration.scope}`);
            }
          }
          
          // 2. Clear ALL caches
          if ('caches' in window) {
            const cacheNames = await caches.keys();
            for (const cacheName of cacheNames) {
              await caches.delete(cacheName);
              logError(`Cleared cache: ${cacheName}`);
            }
          }
          
          // 3. Clear storage
          localStorage.clear();
          sessionStorage.clear();
          
          // 4. Force reload with cache bypass
          logError('ğŸ”„ Reloading with cache bypass...');
          window.location.href = window.location.href + '?sw_reset=' + Date.now();
        } catch (error) {
          logError('âŒ Nuclear reset failed: ' + error.message);
        }
      }
      
      // Bypass service worker entirely
      function bypassServiceWorker() {
        logError('ğŸš« Bypassing service worker...');
        localStorage.setItem('bypass-sw', 'true');
        window.location.href = window.location.href + '?no_sw=' + Date.now();
      }
      
      // Diagnostic reload
      function diagnosticReload() {
        logError('ğŸ”„ Diagnostic reload...');
        window.location.href = window.location.href + '?diag=' + Date.now();
      }
      
      // Test network connectivity
      function testNetwork() {
        fetch('/favicon-16x16.png?t=' + Date.now())
          .then(() => {
            document.getElementById('network-status').textContent = 'Connected âœ…';
          })
          .catch(() => {
            document.getElementById('network-status').textContent = 'Connection Issues âŒ';
            logError('âŒ Network connectivity test failed');
          });
      }
      testNetwork();
      
      // Monitor React app loading
      function checkReactApp() {
        const rootEl = document.getElementById('root');
        if (rootEl && rootEl.children.length > 0) {
          reactLoaded = true;
          document.getElementById('react-status').textContent = 'Loaded âœ…';
          return true;
        }
        return false;
      }
      
      // Show emergency screen if React doesn't load within 5 seconds
      setTimeout(() => {
        if (!reactLoaded && !checkReactApp()) {
          logError('âŒ React app failed to load within 5 seconds');
          document.getElementById('react-status').textContent = 'Failed âŒ';
          document.getElementById('emergency-fallback').style.display = 'block';
          emergencyShown = true;
        }
      }, 5000);
      
      // Enhanced error tracking
      window.addEventListener('error', function(e) {
        const errorMsg = e.filename ? `Script error in ${e.filename}: ${e.message}` : `Error: ${e.message}`;
        logError(errorMsg);
        
        if (e.filename && e.filename.includes('.js')) {
          if (!emergencyShown) {
            document.getElementById('emergency-fallback').style.display = 'block';
            emergencyShown = true;
          }
        }
      });
      
      window.addEventListener('unhandledrejection', function(e) {
        logError(`Promise rejection: ${e.reason}`);
      });
      
      // Service worker registration with complete reset capability
      async function registerServiceWorker() {
        if (!('serviceWorker' in navigator)) {
          document.getElementById('sw-status').textContent = 'Not Supported âŒ';
          return;
        }
        
        // Check if user wants to bypass service worker
        if (localStorage.getItem('bypass-sw') === 'true') {
          document.getElementById('sw-status').textContent = 'Bypassed ğŸš«';
          logError('ğŸš« Service worker bypassed by user');
          return;
        }
        
        try {
          // Force unregister old service workers first
          const existingRegistrations = await navigator.serviceWorker.getRegistrations();
          for (const registration of existingRegistrations) {
            await registration.unregister();
          }
          
          // Register new service worker with cache busting
          const registration = await navigator.serviceWorker.register('/sw.js?v=' + Date.now(), { 
            scope: '/' 
          });
          
          document.getElementById('sw-status').textContent = 'Registered âœ…';
          logError('âœ… Service worker registered successfully');
          
          // Force immediate activation
          if (registration.waiting) {
            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
          }
        } catch (error) {
          document.getElementById('sw-status').textContent = 'Failed âŒ';
          logError('âŒ Service worker registration failed: ' + error.message);
        }
      }
      
      // Register service worker
      registerServiceWorker();
      
      // Debug mode activation
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('debug') === 'true' || urlParams.get('diag') || urlParams.get('sw_reset')) {
        document.getElementById('emergency-fallback').style.display = 'block';
        emergencyShown = true;
      }
    </script>
    
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
